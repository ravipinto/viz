<!DOCTYPE html>
<html>
  <head>
    <title>Bar Chart</title>
    <script type="text/javascript" src="../../d3.js"></script>
    <style type="text/css">

body {
  font: 10px sans-serif;
}

.tweet {
  stroke: indianred;
}
.bar a {
  opacity: 0;
  -webkit-transition: opacity 1s linear;
}

.bar:hover a {
  opacity: 1;
}

.axis {
  stroke-dasharray: 1, 8;
  stroke: #ccc; 
}


    </style>
  </head>
  <body>
    <script type="text/javascript">

var dataset = JSON.parse('./twitter.json');


var height = 20, 
    viewport = 900,
    padding = 10,
    x = d3.scale.linear().range([0, viewport]).domain([0, 23]),
    colorscale = d3.scale.linear().range([1, 0]).domain([0, 5]), 
    bg = d3.hsl("indianred"), 
    totalheight = (height+padding)*maxtweets,
    duration = 1000;

  
  svg = d3.select("body").insert("svg")
            .attr("width", viewport + 20)
            .attr("height",  totalheight + 40)
            .append("g")
            .attr("class", "container")
            .attr("transform", "translate(10, 0)");

  svg.selectAll("line.axis")
  .data(x.ticks(24))
  .enter().append("svg:line")
  .attr("class", "axis")
  .attr("x1", x)
  .attr("x2", x)
  .attr("y1", 0)
  .attr("y2", totalheight +15);  
  
  svg.selectAll("text.rule")
  .data(x.ticks(24))
  .enter().append("svg:text")
  .attr("class", "rule")
  .attr("x", x)
  .attr("y", totalheight + 30)
  .attr("dy", -3)
  .attr("text-anchor", "middle")
  .text(String);  
  redraw();

function redraw() { 
  var bars = svg.selectAll("g.bar").data(data, function(d) { return d.id; });
  
  bars.enter()
      .append("g")
      .attr("class", "bar")    
      .attr("transform", function(d, i) { return "translate(" + x(d.time) + ", " +  i*(height + padding) + ")"; })
      .call(updaterects);
       
  bars.exit().remove();
 
}

function updaterects(selection) {
  selection.each(function(d, i) {
    var that = d3.select(this); 
    var rectdata = d.value;
    var rects = that.selectAll('rect').data(rectdata, function(d, i) { return d; });
    
    rects.enter()
         .append("svg:rect")
         .transition()
         .duration(duration)         
         .attr("x", function(d, i) { return x(i); })
         .attr("width", x(1))
         .attr("height", height)
         .attr("fill", function(d) { return bg.brighter(colorscale(d))});

    
    rects.exit()
         .transition()
         .duration(duration)
         .remove();      

   that.append("svg:a")
   .attr("transform", function(d) { return "translate(" + (x(d.value.length) + 10) + ", " + 15 + ")"; })      
   .attr("xlink:href", "http://example.com")
   .append("svg:text").text(function(d) { return d.desc});

  });
}

init();

window.onkeyup = function(e) {
  if(datacount && (e.keyCode == 37 || e.keyCode == 39)) {
    data = dataset[datacount.pop()];
    redraw();        
  }
};   
    </script>
  </body>
</html>
